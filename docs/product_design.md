# ChainGraph 产品设计目录（独立）

> 作用：沉淀产品设计理念、功能范围、约束与 ISO GQL 支持矩阵。后续代码、文档与发布需遵循本文件，变更须同步更新。

## 1. 设计总览

- **使命**：提供可信、高性能、标准化的 Web3 图数据基础设施，支撑链上安全合规、资产流向分析与实时风险控制。
- **目标用户**：链上安全/风控/合规团队，交易所/托管方数据团队，链上分析公司，研究与审计机构。
- **优先场景**：资金链路追踪、反洗钱检测、合约调用分析、制裁/黑名单筛查、DeFi 流动性与异常交易监控。
- **设计原则**：
  1) 标准优先（ISO GQL 39075 为语义基线，扩展须显式标记且保持后向兼容）。
  2) 数据可信（写入原子性，WAL/快照保障，诊断可追溯）。
  3) 性能确定性（针对 NVMe/SSD 4KB 页面对齐，核心查询低延迟稳定 p95）。
  4) 默认安全（加密、鉴权、最小权限、审计日志默认可用）。
  5) 可运维/可观测（指标/日志/追踪齐全，可回滚配置，故障可定位）。
  6) 简洁一致（CLI/REST/GQL 术语统一，避免隐式魔法）。
- **非目标**：不做通用 OLTP 关系数据库；不承担链上节点同步/索引；不内置 ML 推理；不提供前端可视化 IDE（通过 API 对接）。

## 2. 功能清单与约束

### 2.1 数据模型与存储
- **能力**：属性图（点/边/标签/属性），图为逻辑隔离单元；类型需预定义；元数据版本化。
- **约束**：
  - 点/边属性需强类型；边需指向已存在的端点；标签命名需唯一。
  - 存储对齐 4KB 页，优先 NVMe/SSD；缓冲池/文件句柄/线程池需可配置并暴露水位。

### 2.2 查询与语言（概览）
- **能力**：MATCH/WHERE/RETURN/ORDER BY/LIMIT/SKIP；路径与量化模式；集合运算（UNION/EXCEPT/INTERSECT/OTHERWISE）；聚合与 GROUP BY/HAVING；LET/FOR/FILTER/SELECT；USE 图切换；SHOW/DESCRIBE；CALL 过程调用。
- **约束**：
  - 查询需在当前图上下文内执行；跨图引用需先切换图。
  - 可变长度路径需明确上限；推荐限制深度以防爆炸式搜索。
  - 集合运算要求列对齐且类型兼容。

### 2.3 数据操作（DML）
- **能力**：INSERT/DELETE/UPDATE 支持点、边及属性更新。
- **约束**：
  - 写入遵循强类型；边写入需保证端点存在；写放大受页大小和缓冲池限制。
  - 批量导入（CLI/工具）需匹配模式定义；建议在事务或批次内控制大小与重试策略。

### 2.4 会话与事务
- **能力**：SESSION 管理、TRANSACTION 语句；支持显式事务块。
- **约束**：
  - 会话绑定图上下文；事务失败需回滚；长事务应避免阻塞检查点。
  - 隔离/一致性策略以服务器配置与发布说明为准，变更需文档化。

### 2.5 图算法（通过 CALL）
- **能力**：最短路径、全路径、链路追踪（正/反/双向）、最大流、邻居/度数、连通性检测等过程。
- **约束**：
  - 需提供最大深度或边数限制；大图上建议使用采样/限流。
  - 过程接口需保持稳定签名与返回字段，变更需版本说明。

### 2.6 安全与合规
- **能力**：TLS、鉴权、基于角色/图级的权限控制、审计日志；敏感配置加密存储。
- **约束**：
  - 高危指令（DROP/DDL）需权限或确认；审计日志需可追溯到用户/会话/请求。
  - 合规场景的数据留存/删除策略须可配置并记录。

### 2.7 运维与可观测性
- **能力**：/health 就绪与存活；指标（Prometheus 友好）、结构化日志、可选分布式追踪；慢查询与资源热度上报；备份/恢复接口。
- **约束**：
  - 观测数据需与版本兼容；备份/恢复流程需可重复脚本化，含校验。
  - 配置变更需支持回滚，失败时应提供诊断线索。

### 2.8 兼容性与扩展
- **能力**：算法/导入器/索引策略可模块化替换；REST/CLI 版本化；数据/元数据标记格式版本。
- **约束**：
  - 语法或协议新增需保持后向兼容；弃用项需至少一个版本迁移期与告警。
  - 跨版本数据升级/降级需提供路径或阻断提示。

## 3. ISO GQL 39075 支持矩阵

> 状态说明：✅ 已支持且文档化（见 `docs/manual.md` 6.x/7.x）；🟡 部分/受限；⛔ 当前未提供（需路线或设计）。

### 3.1 已支持（文档化）的 ISO GQL 能力

| 能力 | 状态 | 约束/说明 |
| --- | --- | --- |
| MATCH / WHERE / RETURN / ORDER BY / LIMIT / SKIP | ✅ | 标准模式匹配与投影；排序需显式字段；分页通过 SKIP/LIMIT。 |
| 标签逻辑（析取/合取/否定/通配符） | ✅ | 见 6.2；需使用标准语法，不可与未定义标签混用。 |
| 边方向（7 种） | ✅ | 见 6.2；遵循 ISO 方向语义。 |
| 量化路径模式 `{n}` / `{m,n}` | ✅ | 见 6.2、6.18；建议限制上界防止状态爆炸。 |
| 路径前缀/路径搜索前缀 | ✅ | 见 6.18；支持 ISO 前缀集。 |
| 聚合与 GROUP BY / HAVING | ✅ | 见 6.12；需列对齐；聚合字段需在 GROUP BY 或聚合函数中。 |
| 集合运算 UNION / EXCEPT / INTERSECT / OTHERWISE | ✅ | 见 6.14；列数与类型需一致或可隐式转换。 |
| LET / FOR / FILTER / SELECT | ✅ | 见 6.9–6.12；FOR 迭代遵循 ISO 语义。 |
| USE 图切换 | ✅ | 见 6.13；作用域为当前会话/事务。 |
| SESSION / TRANSACTION | 🟡 | 见 6.15–6.16；已支持 GRAPH TYPE/GRAPH 设置与事务语句，`SESSION SET/RESET PROPERTY GRAPH` 当前未实现，需补齐或在手册标注不支持。 |
| CREATE / DROP GRAPH | ✅ | 见 6.17；图为逻辑隔离单元。 |
| SHOW / DESCRIBE | ✅ | 见 6.19–6.20；只读元信息查询。 |
| CALL 过程调用 | ✅ | 见 7.0；支持 OPTIONAL CALL；过程列表见 7.0 表格。 |
| DML INSERT / DELETE / UPDATE | ✅ | 见 6.6–6.8；写入需符合模式与类型约束。 |

### 3.2 当前未提供或未开放的 ISO GQL 能力（需路线说明）

| 能力 | 状态 | 不支持原因 / 待办 |
| --- | --- | --- |
| 在线模式演化 DDL（如 ALTER LABEL/PROPERTY 变更类型、约束在线变更） | ⛔ | 当前元数据与存储格式未开放在线变更，需通过离线迁移或后续版本提供安全演化路径。 |
| 窗口/分析函数（如 ROW_NUMBER、PARTITION BY 窗口聚合） | ⛔ | 查询计划器未实现窗口执行管线，需评估性能与资源模型后引入。 |
| 时间/空间原生类型与算子（时区感知时间类型、地理空间谓词） | ⛔ | 现阶段聚焦链上整数/字符串/数值类型，尚未引入时空索引与算子。 |
| GQL 内建的权限 DCL（GRANT/REVOKE 语法） | ⛔ | 当前采用服务端 RBAC/配置管理，未在 GQL 层开放 DCL；需统一安全模型后评估。 |
| 用户自定义函数/过程的动态注册（CREATE FUNCTION/PROCEDURE） | ⛔ | 为保证安全与稳定暂未开放动态注册，需设计沙箱与版本治理。 |
| 跨图单语句查询（同时引用多图） | ⛔ | 执行引擎按单图上下文规划，跨图计划与一致性策略待设计。 |

> 上述未提供项若需落地，需：1) 设计与安全评审；2) 补充一致性/性能基线；3) 更新手册与兼容性说明。

## 4. 性能与容量基线（用于验收）
- 点查/邻居查询：期望 p95 ≤ 50ms（缓存命中场景）。
- 短路径（≤3 跳）追踪：期望 p95 ≤ 200ms。
- 批量导入：单实例 NVMe 场景期望 ≥ 50k 边/秒。
- 资源水位：缓冲池/句柄/线程池需暴露指标并可告警。

## 5. 安全与合规准则
- 传输默认加密；敏感配置加密存储；审计日志可追溯到用户/会话/请求。
- 高危操作需权限/确认；默认最小权限。
- 合规（留存/删除、时间同步、防篡改）策略需在部署与文档中声明。

## 6. 版本与兼容策略
- 遵循 SemVer；标记 BREAKING/DEPRECATION；弃用项提供至少一个版本迁移期。
- 语法/协议新增需后向兼容；存储/元数据格式需版本化并提供升级/降级路径或阻断提示。
- 任何与本目录冲突的实现变更，需先更新本文件与发布说明，再落地代码。

## 7. 实现差距与后续优化（结合当前代码现状）
- **安全与合规**：尚无 TLS、鉴权/RBAC、审计日志、敏感配置加密；高危指令缺乏权限/确认保护；需补充留存/删除策略与时间同步、防篡改措施（对照 2.6、0.8）。
- **会话/事务语义**：SESSION/TRANSACTION 仅回显字符串，无会话上下文与事务 WAL/锁/回滚语义；需落地会话绑定图上下文、隔离级别与失败回滚（对照 2.4、6.15–6.16）。
- **多图与图类型管理** ✅ 已实现：CREATE/DROP/USE GRAPH 可创建/删除/切换真实图实例，图目录 `GraphCatalog` 实现多图隔离与图元数据持久化（对照 6.13、6.17、2.1、2.4）。
- **内置类型系统** ✅ 已实现：提供 `builtin_types` 模块，定义 5 种内置 NODE TYPE（__Account、__Transaction、__Block、__Token、__Contract）和 5 种内置 EDGE TYPE（__Transfer、__TxRel、__Call、__Approval、__TokenTransfer），支持在 CREATE GRAPH 中通过 `NODE __Account` 引用。SHOW LABELS/EDGE TYPES 动态返回内置类型完整属性定义（对照 6.17、6.19）。
- **元数据/索引/约束**：SHOW/DESCRIBE 现可返回内置类型元信息，但仍缺乏用户自定义索引、约束管理，也无建索引/建约束 DDL；需补齐元数据存储与查询（对照 6.19–6.20）。
- **运维与可观测性** ✅ 已实现：提供 Prometheus 指标端点（/metrics）和详细统计端点（/stats），包括查询 QPS、缓冲池命中率、慢查询计数、资源水位监控等。缺少结构化日志、分布式追踪、备份/恢复接口（对照 2.7、0.10）。
- **REST 版本与错误码**：HTTP 接口无版本化与兼容策略，错误仅字符串；需分层错误码与纠正提示，完善版本前缀（对照 0.5、0.6、0.9）。
- **性能与资源控制** ✅ 已实现：集成指标收集模块（metrics.rs），BufferPool 水位监控（80% 警告、90% 危险），查询执行时间统计。缺少线程池监控、句柄限流、基线验证与报警（对照 0.7、4.x）。
- **ISO GQL 局限**：文档标记的未实现项（在线模式演化 DDL、窗口函数、时空类型、GQL DCL、UDF/UDP 动态注册、跨图单语句查询）仍为空白，需按 3.2 路线规划。

## 8. 更新记录
### 2026-01-03
- ✅ 实现多图管理：GraphCatalog 支持 CREATE/DROP/USE GRAPH，图目录元数据持久化
- ✅ 实现内置类型系统：builtin_types 模块定义 5 种 NODE TYPE 和 5 种 EDGE TYPE
- ✅ 增强 SHOW LABELS/EDGE TYPES：动态返回内置类型完整属性定义和描述
- ✅ 修复 CLI/Server 编译错误：更新所有入口使用 GraphCatalog 而非直接 Graph
- ✅ 更新文档和示例：添加 builtin_types_demo.gql 演示文件
- ✅ 实现性能监控：metrics 模块提供 Prometheus 格式指标导出
- ✅ 实现资源水位监控：BufferPool 水位状态（Normal/Warning/Critical）
- ✅ 实现查询统计：QPS、平均响应时间、慢查询计数、成功/失败率
- ✅ 实现缓冲池指标：命中率、驱逐次数、脏页写回统计
- ✅ 实现 REST API 监控端点：/metrics（Prometheus 格式）、/stats（JSON 详细信息）
